<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Saudization</title>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
		<style type="text/css">

			circle:hover {
				fill: orange;
			}

			#tooltip {
				position: absolute;
				width: 250px;
				height: auto;
				padding: 10px;
				background-color: white;
				-webkit-border-radius: 10px;
				-moz-border-radius: 10px;
				border-radius: 10px;
				-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				pointer-events: none;
			}
			
			#tooltip.hidden {
				display: none;
			}
			
			#tooltip p {
				margin: 0;
				font-family: sans-serif;
				font-size: 16px;
				line-height: 20px;
			}

			.title {
			  font: 300 78px Helvetica;
			  fill: #666;
			}

			.nomouse {
				stroke-width: 0.75px;
				stroke: white;
				stroke-dasharray: 3,3;
				fill: #66cc99;
			}

			.moused {
				stroke-width: 2px;
				stroke: yellow;
				fill: #39ac73;
				/*stroke-dasharray: 3,3;*/
			}

			.button:hover {
				cursor: pointer;
			}

			#buttons {
				position: absolute;
				width: 200px;
				top: 200px;
				left: 50px;
			}

		</style>
	</head>

	<body>
		<div id="tooltip" class="hidden" style="left: 429px, top: 489.6px">
			<p><strong><span id="provinceName">Riyadh</span></strong></p>
			<p>Saudi workforce: <span id="saudi">XXX</span></p>
			<p>Non-Saudi workforce: <span id="expats">XXX</span></p>
		</div>

		<div id="buttons">
			<p><span id="byPopulation" class="button">By population</span></p>
			<p><span id="byWorkforce" class="button">By workforce</span></p>
			<p><span id="byIndustry" class="button">By industry</span></p>
			<p><span id="byRegion" class="button">By region</span></p>
		</div>

		<script type="text/javascript">

		//THE DATA QUEUE
		queue()
			.defer(d3.json, "_geo/saudi_comp.json")
			.defer(d3.csv, "_data/capitals.csv")
			.defer(d3.csv, "_data/industries.csv")
			.await(ready);
		
		//THE FUNCTION THAT CALLS THE OTHER DRAW FUNCTIONS
		function ready(error,json,csv,new_csv) {
			drawMap(json);
			drawCircles(csv);
			drawBars(new_csv);
		}

		// Setting the basic province to Riyadh
		var userProvince = "Riyadh";

		function mouseover(d) {

				// d3.select(this).style("fill", "orange");
				var comma = d3.format(",");

				var mousecoord = [0,0];
				mousecoord = d3.mouse(this);

				d3.select("#tooltip")
					.style("left", mousecoord[0] + "px")
					.style("top", mousecoord[1]-75 + "px");

				d3.select("#provinceName")
					.text(d.capital);

				d3.select("#saudi")
					.text(comma(d.Saudi));

				d3.select("#expats")
					.text(comma(d['Non-Saudi']));

				d3.select("#tooltip").classed("hidden", false);
		};

		function mouseout(d) {
				// d3.select(this).style("fill", "#66cc99");
				d3.select("#tooltip").classed("hidden", true);
		};

		function hover(d) {
			d3.select(this).attr("class", "moused");
		}


		function demoused(d) {
			d3.select(this).attr("class", "nomouse");
		}
 
		function drawMap(json) {

			var w = 1200;
			var h = 500;

			// Rotating the Earth here...
			// Saudi longlat: 45° E, 24° N
			var projection = d3.geo.mercator()
				.center([0, 24])
				.rotate([-45, 0])
				.scale(1500)
				.translate([w/3, h/2]);

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select("body")
				.append("svg")
				.attr("width", w)
				.attr("height", h);

			var map = d3.select("svg")
				.append("g")
				.attr("class", "map");

			var comma = d3.format(",");

			var provinces = topojson.feature(json, json.objects.saudi);
				
			map.selectAll("path")
			   .data(provinces.features)
			   .enter()
			   .append("path")
			   .attr("d", path)
			   .attr("class", "province nomouse")
			   .attr("id", function(d) { return d.id; });


			// Clicking on buttons
			var toggle = false;

			d3.selectAll("#byPopulation, #byWorkforce").on("click", function() {
				console.log(this);

				toggle = !toggle;
				console.log(toggle);

				d3.selectAll(".chart").remove();

				if (toggle == true) {
					console.log("Adding circles");
					console.log(toggle);

					d3.csv("_data/capitals.csv", drawCircles);		
				}
				else if (toggle == false) {
					console.log("Removing circles");
					console.log(toggle);
					d3.selectAll(".capitals").remove();
				}

			});
		   

		   d3.select("#byRegion").on("click", function() {

		   		d3.selectAll("circle").remove(); 
		   		toggle = !toggle;
		   		console.log(toggle);

		   		if (toggle == true) {
		   			d3.csv("_data/industries.csv", drawBars);		
		   		}
		   		else if (toggle == false) {
		   			d3.selectAll(".chart").remove();
		   		}

		   });
		
		} //drawMap


		function drawCircles(csv) {

			var radius = d3.scale.sqrt()
				.domain([1, d3.max(csv, function(d) { return d.Total; })])
				.range([2, 25]);

			var capitals = d3.select(".map").selectAll("g")
				.data(csv)
				.enter()
				.append("g")
				.attr("id", function(d) { return d.capital; })
				.attr("class", "capitals")
				.on("mouseover", mouseover)
	   			.on("mouseout", mouseout);

			// SAUDI
		   	capitals.append("circle")
		   		.attr("cx", function(d) {
		   			return projection([d.lon, d.lat])[0];
		   		})
		   		.attr("cy", function(d) {
		   			return projection([d.lon, d.lat])[1];
		   		})
		   		.attr("r", function(d) {
		   			return radius(d.Saudi);
		   		})
		   		.attr("class", "Saudi")
		   		.style("fill", "#cc6699")
		   		.style("opacity", 0.6);


		   	// NON-SAUDI
		   	capitals.append("circle")
		   		.attr("cx", function(d) {
		   			return projection([d.lon, d.lat])[0];
		   		})
		   		.attr("cy", function(d) {
		   			return projection([d.lon, d.lat])[1];
		   		})
		   		.attr("r", function(d) {
		   			return radius(d['Non-Saudi']);
		   		})
		   		.attr("class", "non-Saudi")
		   		.style("fill", "#3973ac")
		   		.style("opacity", 0.6);

		} //drawCircles


				// function chooseBars(d) {


				// 	// console.log(userProvince);

				// 	// if (d.region == userProvince) {
				// 	// 	return d;
				// 	// }
				// 	// else {
				// 	// 	null;
				// 	// }

				// 	return d;

				// }


		function drawBars(new_csv) {

			console.log(userProvince);

			data = new_csv;

			var barWidth = 10;

			var y = d3.scale.linear()
				.domain([0, 600000]) //from the policy brief scale
				.range([0, h/2]);

			var chart = d3.select("svg")
				.append("g")
				.attr("class", "chart");

			filtered = data.filter(function(row) {
				return row['region'] == "Riyadh";
			})

			// DATA JOIN
			var bar = chart.selectAll("g")
				.data(filtered);
			
			bar.enter()
				.append("g")
				.attr("class", function(d) { return "bar " + d.region; })
				.attr("transform", function(d, i) { return "translate(" + (i * barWidth + 3*(w/4)) + ",0)"; });

			// SAUDI 
			saudiRects = bar.append("rect")
				.attr("width", "5px")
				.attr("fill", "steelblue")
				.attr("opacity", "0.7");

			saudiRects.attr("height", function(d) { 
					return h/3 - y(d.Saudi);
				})
				.attr("y", function(d) { return y(d.Saudi); })
				.attr("class", function(d) { return "Saudi " + d.industry; })
				

			// NON-SAUDI
			expatRects = bar.append("rect")
				.attr("width", "5px")
				.attr("fill", "pink")
				.attr("opacity", "0.7");

			expatRects.attr("height", function(d) { 
					return h/3 - y(d['Non-Saudi']);
				})
				.attr("y", function(d) { return y(d['Non-Saudi']); })
				.attr("class", function(d) { return "Non-Saudi " + d.industry; })


	   		function update(d) {

	   			d3.select(this).attr("class", "moused");
				userProvince = d.id;

				filtered = data.filter(function(row) {
					return row['region'] == userProvince;
				});

				// chart.selectAll(".bar")
				chart.selectAll("g")
					.data(filtered)
					.enter()
					.append("g")
					.attr("class", function(d) { return "bar " + d.region; })
					.attr("transform", function(d, i) { return "translate(" + (i * barWidth + 3*(w/4)) + ",0)"; });

				console.log(d3.selectAll(".bar"));

				bar.exit().remove();
				
				debugger;

				saudiRects.transition()
					.attr("height", function(d) { 
						return h/3 - y(d.Saudi);
					})
					.attr("y", function(d) { return y(d.Saudi); })
					.attr("class", function(d) { return "Saudi " + d.industry; })

				// expatRects.attr("height")

			} //update func

			map.selectAll("path")
				.on("mouseover", hover)
	   			.on("mouseout", demoused)
	   			.on("click", update);

		} //drawBars

					
			
		</script>
	</body>
</html>