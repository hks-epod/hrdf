<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Saudization</title>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
		<link href='https://fonts.googleapis.com/css?family=Nunito:300,400' rel='stylesheet' type='text/css'>
		<link href='https://fonts.googleapis.com/css?family=PT+Sans:400,400italic' rel='stylesheet' type='text/css'>
		<style type="text/css">

		div {
			font: 200 20px/24px 'Franklin Gothic Medium', sans-serif;
		}

		.button {
			background-color: white;
			color: #ababab;
		}

		.selected {
			background-color: #ababab;
			color: white;
		} 

		#tooltip {
			position: absolute;
			width: 250px;
			height: auto;
			padding: 10px;
			background-color: white;
			-webkit-border-radius: 10px;
			-moz-border-radius: 10px;
			border-radius: 10px;
			-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			pointer-events: none;
		}
		
		#tooltip.hidden {
			display: none;
		}
		
		#tooltip p {
			margin: 0;
			font: 300 16px/20px 'Nunito', sans-serif;
		}

		.title, .hoverTitle {
		  font: 200 42px 'Franklin Gothic Medium', sans-serif;
		}

		.title {
			fill: #d2d2d2;
		}

		.hoverTitle {
			fill: #ececec;
		}

		.nomouse {
			stroke-width: 0.75px;
			stroke: white;
			stroke-dasharray: 3,3;
			fill: #66cc99;
		}

		.moused {
			stroke-width: 2px;
			stroke: yellow;
			fill: #39ac73;
		}

		.saudi {
			fill: #ffffad;
			stroke-width: "1px";
			stroke: #ffd6ad;
		}

		.expat {
			fill: #ffb061;
			stroke-width: "1px";
			stroke: #ff6161;
		}

		.bars {
			opacity: 0.7;
		}

		.button:hover {
			cursor: pointer;
		}

		#buttons {
			position: absolute;
			width: 200px;
			top: 200px;
			left: 50px;
		}

		</style>
	</head>

	<body>
		<div id="tooltip" class="hidden" style="left: 429px, top: 489.6px">
			<p><strong><span id="provinceName">Riyadh</span></strong></p>
			<p>Saudi workforce: <span id="saudi">XXX</span></p>
			<p>Non-Saudi workforce: <span id="expats">XXX</span></p>
		</div>

		<div id="buttons">
			<p><span id="byWorkforce" class="button">By workforce</span></p>
			<p><span id="byIndustry" class="button">By industry</span></p>
			<p><span id="byRegion" class="button">By region</span></p>
		</div>

		<script type="text/javascript">

		// Putting these in the global scope - otherwise, how do I return and pass?
		var w = 1200,
			h = 500;

		// Rotating the Earth here...
		// Saudi longlat: 45° E, 24° N
		var projection = d3.geo.mercator()
			.center([0, 24])
			.rotate([-45, 0])
			.scale(1500)
			.translate([w/3, h/2]);

		// Setting the basic province to Riyadh
		var userProvince = "Riyadh";


		//THE DATA QUEUE
		queue()
			.defer(d3.json, "_geo/saudi_comp.json")
			.defer(d3.csv, "_data/capitals.csv", processCapitals)
			.defer(d3.csv, "_data/industries.csv")
			.await(ready);
		
		//THE FUNCTION THAT CALLS THE OTHER DRAW FUNCTIONS
		function ready(error,json,csv,new_csv) {
			drawMap(json);
			userButtons(csv, new_csv);
		}


		function mouseover(d) {
			var comma = d3.format(",");
			var mousecoord = [0,0],
				mousecoord = d3.mouse(this),
				style = window.getComputedStyle(this, null),
				thisColor = style['fill'];

			d3.select("#tooltip")
				.style("left", mousecoord[0] + w/2 + "px")
				.style("top", mousecoord[1] + h/2 + "px");

			d3.select(this)
				.style("stroke-width", "2px")
				.style("fill", d3.rgb(thisColor).darker());
			
			d3.select("#provinceName").text(this.parentNode.__data__.capital + " province");
			d3.select("#saudi").text(comma(this.parentNode.__data__.Saudi));
			d3.select("#expats").text(comma(this.parentNode.__data__['Non-Saudi']));

			if (d.data == this.parentNode.__data__.Saudi) {
				d3.select("#saudi").style("background-color", "yellow");
				d3.select("#expats").style("background-color", null);
			} else if (d.data == this.parentNode.__data__['Non-Saudi']) {
				d3.select("#saudi").style("background-color", null);
				d3.select("#expats").style("background-color", "yellow");
			}

			d3.select("#tooltip").classed("hidden", false);
		};


		function mouseout(d) {
			d3.select("#tooltip").classed("hidden", true);

			// Feels really hacky :/
			style = window.getComputedStyle(this, null),
			thisColor = style['fill'];

			
			d3.select(this)
				.style("stroke-width", "1px")
				.style("fill", d3.rgb(thisColor).brighter());
		};


		function hover(d) {
			d3.select(this).attr("class", "moused");
			hoverProvince = d.id;
			
			d3.select("#chartTitle")
				.text(hoverProvince)
				.classed("title", false)
				.classed("hoverTitle", true)
				.attr("fill", "#ececec");
		}


		function demoused(d) {
			d3.select(this).attr("class", "nomouse");

			// TODO: Make this a function of userProvince.
			d3.select("#chartTitle")
				.text("Riyadh")
				.classed("hoverTitle", false)
				.classed("title", true); 
		}


		function processCapitals(d) {
			d.Total = +d.Total; //TODO: Replace w Eric's destring func.
			d.Saudi = +d.Saudi;
			d['Non-Saudi'] = +d['Non-Saudi'];

			return d;

		}


		function userButtons(csv, new_csv) {
			var toggle = false;

			d3.selectAll("#byWorkforce").on("click", function() {
				toggle = !toggle;
				d3.selectAll(".chart").remove();

				d3.select(".map").selectAll("path")
		   				.on("mouseover", null)
		   				.on("mouseout", null)
		   				.classed("nomouse", true)
		   				.classed("moused", false);

				if (toggle == true) {
					d3.select(".chart").remove();
					d3.select("#byWorkforce").classed("button selected", true);
					drawPies(csv);		
				}
				else if (toggle == false) {
					d3.select(".circleLayer").remove();
					d3.selectAll(".button").classed("selected", false);
				}

			});
		   

		   d3.select("#byRegion").on("click", function() {

		   		d3.selectAll("circle").remove(); 
		   		toggle = !toggle;

		   		if (toggle == true) {
		   			d3.select(".circleLayer").remove();
		   			d3.select("#byRegion").classed("button selected", true);
		   			drawBars(new_csv);		
		   		}
		   		else if (toggle == false) {
		   			d3.select(".chart").remove();
		   			d3.select(".map").selectAll("path")
		   				.on("mouseover", null)
		   				.on("mouseout", null)
		   				.classed("nomouse", true)
		   				.classed("moused", false);

		   			d3.selectAll(".button").classed("selected", false);
		   		}

		   });

		} //userButtons
 

		function drawMap(json) {

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select("body")
				.append("svg")
				.attr("width", w)
				.attr("height", h);

			var map = d3.select("svg")
				.append("g")
				.attr("class", "map");

			var comma = d3.format(",");

			var provinces = topojson.feature(json, json.objects.saudi);
				
			map.selectAll("path")
			   .data(provinces.features)
			   .enter()
			   .append("path")
			   .attr("d", path)
			   .attr("class", "province nomouse")
			   .attr("id", function(d) { return d.id; });
		
		} //drawMap


		function drawPies(csv) {

			var radius = d3.scale.sqrt()
				.domain([1, d3.max(csv, function(d) { return d.Total; })])
				.range([5, 30]);

			var arc = d3.svg.arc();
			
			arc.innerRadius(0)
				.outerRadius(function(d) { return radius(this.parentNode.__data__.Total); });

			var pie = d3.layout.pie()
				.value(function(d) { return d; });
		
			var circleLayer = d3.select("svg")
							.append("g")
							.attr("class", "circleLayer");

			var pies = circleLayer.selectAll(".pie")
				.data(csv)
				.enter()
				.append("g")
				.attr("id", function(d) { return d.capital; })
				.attr("class", "pie")
    			.attr("transform", function(d) {
    				return "translate(" + projection([d.lon, d.lat])[0] + "," + projection([d.lon, d.lat])[1] + ")";
    				});

			pies.selectAll(".slice")
				.data(function(d) {
					return pie([d['Saudi'], d['Non-Saudi']]);
				})
				.enter()
				.append('path')
				.attr('d',  arc)
				.attr('class', 'slice')
				.attr('class', function(d, i) { 
					// Terrible hack
					if (i==0) { return "saudi"; }
					if (i==1) { return "expat"; }
				})
				.on("mouseover", mouseover)
	   			.on("mouseout", mouseout);

		} //drawCircles


		function drawBars(new_csv) {

			data = new_csv;

			var barWidth = 10;

			var y = d3.scale.linear()
				.domain([0, 600000]) //from the policy brief scale
				.range([0, h/2]);

			var xAxis = d3.svg.axis()
							.orient("bottom");

			var yAxis = d3.svg.axis()
							  .scale(y)
							  .orient("left")
							  .ticks(5);

			var chart = d3.select("svg")
				.append("g")
				.attr("class", "chart")
					.attr("transform", "translate(-300, 75)");

			
			// FILTERING THE DATA
			filtered = data.filter(function(row) {
				return row['region'] == "Riyadh";
			})

			var bar = chart.selectAll("g")
				.data(filtered)
				.enter()
				.append("g")
				.attr("class", function(d) { return "bar " + d.region; })
				.attr("transform", function(d, i) { return "translate(" + (i * barWidth * 2 + 3*(w/4)) + ",0)"; });

			// SAUDI 
			saudiRects = bar.append("rect")
				.attr("width", barWidth);

			saudiRects.attr("height", function(d) { 
					return h/3 - y(d.Saudi);
				})
				.attr("y", function(d) { return y(d.Saudi); })
				.attr("class", function(d) { return "bars saudi " + d.industry; })
				

			// NON-SAUDI
			expatRects = bar.append("rect")
				.attr("width", barWidth);

			expatRects.attr("height", function(d) { 
					return h/3 - y(d['Non-Saudi']);
				})
				.attr("y", function(d) { return y(d['Non-Saudi']); })
				.attr("class", function(d) { return "bars expat " + d.industry; })

			// BAR CHART TITLE
			chart.append("text")
				.attr("x", (w/2 + 400) + "px")
				.attr("y", "-10px")
				.attr("id", "chartTitle")
				.classed("title", true)
				.text(function(d) { 
					return "Riyadh";
					});


			// AXES

			// debugger;
			//TODO: Fix this - breaking on ordinal.
			// xAxis.domain(filtered.map(function(d) { return d.industry; })); 
			
			chart.call(xAxis);
			// chart.call(yAxis);



			// UPDATING THE REGION
	   		function update(d) {

	   			console.log("In the update function.");

	   			d3.select(this).attr("class", "moused");
				userProvince = d.id;

				filtered = data.filter(function(row) {
					console.log("Filtering...");
					return row['region'] == userProvince;
				});

				bar = d3.selectAll('.bar').data(filtered);

				var new_bars = bar.enter()
					.append("g")
					.attr("transform", function(d, i) { return "translate(" + (i * barWidth + 3*(w/4)) + ",0)"; })
					
				new_bars.append("rect")
					.attr("width", barWidth)
					.attr("class", "bars saudi");

				new_bars.append("rect")
					.attr("width", barWidth)
					.attr("class","bars expat");

				bar.exit().remove();

				bar.attr("class", function(d) { 
						console.log("Adding the new class..." + d.region)
						return "bar " + d.region; 
					});
				
				// UPDATING THE BAR CHART
				saudiRects = chart.selectAll(".bars.saudi");
				saudiRects.transition()
					.attr("height", function(d) { 
						return h/3 - y(this.parentNode.__data__.Saudi);
					})
					.attr("y", function(d) { return y(this.parentNode.__data__.Saudi); });

				expatRects = chart.selectAll(".bars.expat");
				expatRects.transition()
					.attr("height", function(d) {
						return h/3 - y(this.parentNode.__data__['Non-Saudi']);	
						})
					.attr("y", function(d) { return y(this.parentNode.__data__['Non-Saudi']); });

				d3.select(this)
					.attr("class", "moused");

			} //update func


			// HIGHLIGHT THE SELECTED USER PROVINCE
			d3.select(".map").selectAll("path")
				.on("mouseover", hover)
	   			.on("mouseout", demoused)
	   			.on("click", update);

	   		// d3.select("path#Riyadh")
	   		// 	.attr("class", "moused")
	   		// 	.on("mouseout", null);

		} //drawBars

					
			
		</script>
	</body>
</html>